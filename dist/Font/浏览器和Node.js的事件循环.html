<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事件循环理解 | Atom</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="敲就硬敲">
    <link rel="preload" href="/assets/css/0.styles.edf51690.css" as="style"><link rel="preload" href="/assets/js/app.bd0d2868.js" as="script"><link rel="preload" href="/assets/js/3.1ca9eadf.js" as="script"><link rel="preload" href="/assets/js/1.ad416145.js" as="script"><link rel="preload" href="/assets/js/74.53a7fd75.js" as="script"><link rel="prefetch" href="/assets/js/10.b58d8229.js"><link rel="prefetch" href="/assets/js/100.f81543c8.js"><link rel="prefetch" href="/assets/js/101.c49c2faa.js"><link rel="prefetch" href="/assets/js/102.a40fe48d.js"><link rel="prefetch" href="/assets/js/103.ae624ca3.js"><link rel="prefetch" href="/assets/js/104.efb41621.js"><link rel="prefetch" href="/assets/js/105.bf7c2ab8.js"><link rel="prefetch" href="/assets/js/106.e2a5af05.js"><link rel="prefetch" href="/assets/js/107.781d41e5.js"><link rel="prefetch" href="/assets/js/108.62bb1d03.js"><link rel="prefetch" href="/assets/js/109.8282e6e4.js"><link rel="prefetch" href="/assets/js/11.f160bd70.js"><link rel="prefetch" href="/assets/js/110.594032f9.js"><link rel="prefetch" href="/assets/js/111.f95c952a.js"><link rel="prefetch" href="/assets/js/112.6b15ed23.js"><link rel="prefetch" href="/assets/js/113.ad65e952.js"><link rel="prefetch" href="/assets/js/114.a4f54b5c.js"><link rel="prefetch" href="/assets/js/115.e123782c.js"><link rel="prefetch" href="/assets/js/116.e1b2f19d.js"><link rel="prefetch" href="/assets/js/117.1f72dcfc.js"><link rel="prefetch" href="/assets/js/118.e238ff89.js"><link rel="prefetch" href="/assets/js/119.a8c2adec.js"><link rel="prefetch" href="/assets/js/12.ddf8f896.js"><link rel="prefetch" href="/assets/js/120.823e4224.js"><link rel="prefetch" href="/assets/js/121.0663b79e.js"><link rel="prefetch" href="/assets/js/122.4790bdcd.js"><link rel="prefetch" href="/assets/js/123.6668948a.js"><link rel="prefetch" href="/assets/js/124.f42cbc80.js"><link rel="prefetch" href="/assets/js/125.67cdad57.js"><link rel="prefetch" href="/assets/js/126.bab4d885.js"><link rel="prefetch" href="/assets/js/127.5139e4b5.js"><link rel="prefetch" href="/assets/js/128.d34717e7.js"><link rel="prefetch" href="/assets/js/129.1507fefd.js"><link rel="prefetch" href="/assets/js/13.f22a8ce2.js"><link rel="prefetch" href="/assets/js/130.b8954dd4.js"><link rel="prefetch" href="/assets/js/131.fc15be83.js"><link rel="prefetch" href="/assets/js/14.05625ca1.js"><link rel="prefetch" href="/assets/js/15.5f8514a3.js"><link rel="prefetch" href="/assets/js/16.880fa1da.js"><link rel="prefetch" href="/assets/js/17.9aade7ea.js"><link rel="prefetch" href="/assets/js/18.4b8f6e2a.js"><link rel="prefetch" href="/assets/js/19.d5756f92.js"><link rel="prefetch" href="/assets/js/20.98ea9903.js"><link rel="prefetch" href="/assets/js/21.b5521d42.js"><link rel="prefetch" href="/assets/js/22.57e7c692.js"><link rel="prefetch" href="/assets/js/23.b168bb94.js"><link rel="prefetch" href="/assets/js/24.5e9b145b.js"><link rel="prefetch" href="/assets/js/25.56d3d124.js"><link rel="prefetch" href="/assets/js/26.5999f8d9.js"><link rel="prefetch" href="/assets/js/27.74f060c7.js"><link rel="prefetch" href="/assets/js/28.53a0ea96.js"><link rel="prefetch" href="/assets/js/29.44ab6a9e.js"><link rel="prefetch" href="/assets/js/30.af5c5cac.js"><link rel="prefetch" href="/assets/js/31.324f70a6.js"><link rel="prefetch" href="/assets/js/32.0d2465b0.js"><link rel="prefetch" href="/assets/js/33.79fcca29.js"><link rel="prefetch" href="/assets/js/34.80af0904.js"><link rel="prefetch" href="/assets/js/35.6cdce270.js"><link rel="prefetch" href="/assets/js/36.07fcd971.js"><link rel="prefetch" href="/assets/js/37.165f4524.js"><link rel="prefetch" href="/assets/js/38.50133769.js"><link rel="prefetch" href="/assets/js/39.0633f006.js"><link rel="prefetch" href="/assets/js/4.a945c363.js"><link rel="prefetch" href="/assets/js/40.766ab4fa.js"><link rel="prefetch" href="/assets/js/41.812f72ce.js"><link rel="prefetch" href="/assets/js/42.90918258.js"><link rel="prefetch" href="/assets/js/43.dc88cec0.js"><link rel="prefetch" href="/assets/js/44.76c2cab0.js"><link rel="prefetch" href="/assets/js/45.3b2df3c3.js"><link rel="prefetch" href="/assets/js/46.54c8ab22.js"><link rel="prefetch" href="/assets/js/47.f93ceabd.js"><link rel="prefetch" href="/assets/js/48.a648a5f6.js"><link rel="prefetch" href="/assets/js/49.bcd0aa52.js"><link rel="prefetch" href="/assets/js/5.4f41f567.js"><link rel="prefetch" href="/assets/js/50.2ffee918.js"><link rel="prefetch" href="/assets/js/51.11ecc3ca.js"><link rel="prefetch" href="/assets/js/52.8f8c408d.js"><link rel="prefetch" href="/assets/js/53.5fe64e57.js"><link rel="prefetch" href="/assets/js/54.007a6d93.js"><link rel="prefetch" href="/assets/js/55.9c4a38c9.js"><link rel="prefetch" href="/assets/js/56.3e99a0ba.js"><link rel="prefetch" href="/assets/js/57.343211f6.js"><link rel="prefetch" href="/assets/js/58.6a32b0f5.js"><link rel="prefetch" href="/assets/js/59.c4354fb3.js"><link rel="prefetch" href="/assets/js/6.0eabcf21.js"><link rel="prefetch" href="/assets/js/60.d5470b4c.js"><link rel="prefetch" href="/assets/js/61.385ef85a.js"><link rel="prefetch" href="/assets/js/62.075a63e9.js"><link rel="prefetch" href="/assets/js/63.004c193f.js"><link rel="prefetch" href="/assets/js/64.934ff6e3.js"><link rel="prefetch" href="/assets/js/65.8e012fd9.js"><link rel="prefetch" href="/assets/js/66.305c90c4.js"><link rel="prefetch" href="/assets/js/67.e371a363.js"><link rel="prefetch" href="/assets/js/68.16362eac.js"><link rel="prefetch" href="/assets/js/69.5be4c403.js"><link rel="prefetch" href="/assets/js/7.9685f570.js"><link rel="prefetch" href="/assets/js/70.a85205e0.js"><link rel="prefetch" href="/assets/js/71.af05dec8.js"><link rel="prefetch" href="/assets/js/72.dd429505.js"><link rel="prefetch" href="/assets/js/73.b6137925.js"><link rel="prefetch" href="/assets/js/75.29de7344.js"><link rel="prefetch" href="/assets/js/76.0439bd9a.js"><link rel="prefetch" href="/assets/js/77.beef4279.js"><link rel="prefetch" href="/assets/js/78.51ac9fe9.js"><link rel="prefetch" href="/assets/js/79.2a494083.js"><link rel="prefetch" href="/assets/js/8.18b743d3.js"><link rel="prefetch" href="/assets/js/80.3f012151.js"><link rel="prefetch" href="/assets/js/81.ee793ac8.js"><link rel="prefetch" href="/assets/js/82.4b4c57cd.js"><link rel="prefetch" href="/assets/js/83.8bf207e5.js"><link rel="prefetch" href="/assets/js/84.acd9b2c9.js"><link rel="prefetch" href="/assets/js/85.c73408fd.js"><link rel="prefetch" href="/assets/js/86.3ab5bdc0.js"><link rel="prefetch" href="/assets/js/87.2be0c1ee.js"><link rel="prefetch" href="/assets/js/88.03ea9088.js"><link rel="prefetch" href="/assets/js/89.5dd7b5be.js"><link rel="prefetch" href="/assets/js/9.dd6bf762.js"><link rel="prefetch" href="/assets/js/90.53931b44.js"><link rel="prefetch" href="/assets/js/91.878c9891.js"><link rel="prefetch" href="/assets/js/92.f7ab2ddd.js"><link rel="prefetch" href="/assets/js/93.7529e278.js"><link rel="prefetch" href="/assets/js/94.e50ec021.js"><link rel="prefetch" href="/assets/js/95.e96fd4bb.js"><link rel="prefetch" href="/assets/js/96.06759a6c.js"><link rel="prefetch" href="/assets/js/97.1a0b80ad.js"><link rel="prefetch" href="/assets/js/98.03722e08.js"><link rel="prefetch" href="/assets/js/99.027e0acb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.edf51690.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-dad8a512><div data-v-dad8a512><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-dad8a512 data-v-dad8a512><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-dad8a512 data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Atom</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>atom</span>
            
          <span data-v-64685f0e>2019 - </span>
          2020
        </a></span></div></div> <div class="hide" data-v-dad8a512><header class="navbar" data-v-dad8a512><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="./images/avator.jpg" alt="Atom" class="logo"> <span class="site-name">Atom</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      学习资源
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Font/.html" class="nav-link"><i class="iconfont undefined"></i>
  前端学习路线
</a></li></ul></div></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-dad8a512></div> <aside class="sidebar" data-v-dad8a512><div class="personal-info-wrapper" data-v-ca798c94 data-v-dad8a512><img src="./images/avator.jpg" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    atom
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>62</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>83</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      学习资源
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Font/.html" class="nav-link"><i class="iconfont undefined"></i>
  前端学习路线
</a></li></ul></div></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>常用工具和库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tool/Jquery.html" class="sidebar-link">Jquery常用api使用教程</a></li><li><a href="/tool/Jquery2.html" class="sidebar-link">Jquery学习</a></li><li><a href="/tool/Superagent.html" class="sidebar-link">SuperAgent和cheerio库的使用</a></li><li><a href="/tool/axios.html" class="sidebar-link">axios的基本用法</a></li><li><a href="/tool/CV基本原理.html" class="sidebar-link">CV制作的基本原理</a></li><li><a href="/tool/数据库的使用.html" class="sidebar-link">配置Vue项目上线</a></li><li><a href="/tool/跨域详解.html" class="sidebar-link">跨域及跨域解决方案</a></li><li><a href="/tool/微信js-sdk配置.html" class="sidebar-link">微信Js-sdk配置</a></li><li><a href="/tool/koa2与express的差异.html" class="sidebar-link">koa2和express两种框架模型对比</a></li><li><a href="/tool/Node调用脚本.html" class="sidebar-link">Node调用脚本</a></li><li><a href="/tool/模块导出规范.html" class="sidebar-link">javaScript中的模块导出</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Font/" class="sidebar-heading clickable router-link-active"><span>前端知识</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6常用方法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>正则系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mongodb手册</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工作记录</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>goLang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>python</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>事件循环理解</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>atom</span>
            
          <span data-v-64685f0e>2019 - </span>
          2020
        </a></span></div></div> <div data-v-dad8a512><main class="page"><div class="page-title" style="display:none;"><h1>事件循环理解</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>atom</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2020-05-16</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>事件循环</span><span class="tag-item" data-v-3b7f5bdf>异步</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h3 id="不要混淆浏览器和node-js的事件循环"><a href="#不要混淆浏览器和node-js的事件循环" class="header-anchor">#</a> 不要混淆浏览器和Node.js的事件循环</h3> <p>1.不同的事件循环(Node.js)</p> <ul><li>nodejs的event是基于libuv，而浏览器的event loop则在html5的规范中明确定义。</li> <li>libuv已经对event loop作出了实现，而html5规范中只是定义了浏览器中event loop的模型，具体实现留给了浏览器厂商</li></ul> <h4 id="node的事件循环分为6个阶段-每个阶段的作用如下-process-nexttick-在6个阶段的结束的时候都会执行"><a href="#node的事件循环分为6个阶段-每个阶段的作用如下-process-nexttick-在6个阶段的结束的时候都会执行" class="header-anchor">#</a> node的事件循环分为6个阶段，每个阶段的作用如下(process.nextTick()在6个阶段的结束的时候都会执行)</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>   ┌───────────────────────┐
┌─<span class="token operator">&gt;</span>│        timers         │
│  └──────────┬────────────┘
│  ┌──────────┴────────────┐
│  │     I/O callbacks     │
│  └──────────┬────────────┘
│  ┌──────────┴────────────┐
│  │     idle, prepare     │
│  └──────────┬────────────┘      ┌───────────────┐
│  ┌──────────┴────────────┐      │   incoming:   │
│  │         poll          │<span class="token operator">&lt;</span>─────┤  connections, │
│  └──────────┬────────────┘      │   data, etc.  │
│  ┌──────────┴────────────┐      └───────────────┘
│  │        check          │
│  └──────────┬────────────┘
│  ┌──────────┴────────────┐
└──┤    close callbacks    │
   └───────────────────────┘
</code></pre></div><ul><li>timers ：执行setTimeout和setInterval中到期的callback</li> <li>I/O callbacks：不在 timers 阶段、close callbacks 阶段和 check 阶段这三个阶段执行的回调，都由此阶段负责，这几乎包含了所有回调函数。</li> <li>idle, prepare：仅内部使用</li> <li>poll：最为重要的阶段。获取新的 I/O 事件，执行I/O callback，在适当的条件下会阻塞在这个阶段</li> <li>check：执行setImmediate的callback</li> <li>close callbacks：执行close事件的callback，例如socket.on(&quot;close&quot;,func)</li></ul> <p>event loop的每一次循环都需要依次经过上述的阶段。  每个阶段都有自己的callback队列，
先入先出的队列，这个队列存有要执行的回调函数的地址
每当进入某个阶段，都会从所属的队列中取出callback来执行，当队列为空或者被执行callback的数量达到系统的最大数量时，进入下一阶段。这六个阶段都执行完毕称为一轮循环。</p> <h4 id="timers阶段"><a href="#timers阶段" class="header-anchor">#</a> Timers阶段</h4> <ul><li>在timer阶段其实使用一个最小堆而不是队列来保存所有元素（其实也可以理解，因为timeout的callback是按照超时时间的顺序来调用的，并不是先进先出的队列逻辑），然后循环取出所有到期的callback执行。</li> <li>计时器实际上是在指定多久以后可以执行某个回调函数，而不是指定某个函数的确切执行时间。当指定的时间达到后，计时器的回调函数会尽早被执行。如果操作系统很忙，或者 Node.js 正在执行一个耗时的函数，那么计时器的回调函数就会被推迟执行。
注意，从原理上来说，poll 阶段能控制计时器的回调函数什么时候被执行。</li> <li>举例来说，你设置了一个计时器在 100 毫秒后执行，然后你的脚本用了 95 毫秒来异步读取了一个文件：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 假设读取这个文件一共花费 95 毫秒</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'/path/to/file'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> timeoutScheduled <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> delay <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timeoutScheduled<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">毫秒后执行了 setTimeout 的回调</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 执行一个耗时 95 毫秒的异步操作</span>
<span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> startCallback <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 执行一个耗时 10 毫秒的同步操作</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startCallback <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 什么也不做</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当 event loop 进入 poll 阶段，发现 poll 队列为空（因为文件还没读完），event loop 检查了一下最近的计时器，大概还有 100 毫秒时间，于是 event loop 决定这段时间就停在 poll 阶段。在 poll 阶段停了 95 毫秒之后，fs.readFile 操作完成，一个耗时 10 毫秒的回调函数被系统放入 poll 队列，于是 event loop 执行了这个回调函数。执行完毕后，poll 队列为空，于是 event loop 去看了一眼最近的计时器（译注：event loop 发现卧槽，已经超时 95 + 10 - 100 = 5 毫秒了），于是经由 check 阶段、close callbacks 阶段绕回到 timers 阶段，执行 timers 队列里的那个回调函数。这个例子中，100 毫秒的计时器实际上是在 105 毫秒后才执行的。</p> <h4 id="i-o-callback阶段"><a href="#i-o-callback阶段" class="header-anchor">#</a> I/O callback阶段</h4> <p>callbacks是上轮残留的。这个阶段执行一些系统操作的回调，比如说TCP连接发生错误。</p> <h4 id="idle-prepare"><a href="#idle-prepare" class="header-anchor">#</a> idle,prepare</h4> <p>系统内部操作的调用</p> <h4 id="poll"><a href="#poll" class="header-anchor">#</a> poll</h4> <ul><li><p>如果发现计时器的时间到了，就绕回到 timers 阶段执行计时器的回调。</p></li> <li><p>处理poll队列里的事件
node中的很多事件都是基于事件订阅完成的，这些API的回调都在poll阶段中完成</p></li> <li><p>当事件循环进入poll阶段</p> <ol><li><p>poll队列不为空时，事件循环先遍历队列执行回调，直到队列清空或回调函数执行到达上限</p></li> <li><p>poll为空时</p> <p>2.1 如果代码已经被setImmediate()设定了回调，则进入check阶段，执行check里面的回调</p> <p>2.2 如果没有设定setImmediate()回调</p></li></ol></li> <li><p>如果有被设定的timers，那么此时事件循环会检查timers，如果有一个或多个timers下限时间已经到达，那么事件循环将绕回timers阶段，并执行timers的有效回调队列。</p></li> <li><p>如果没有设定timers，那么事件循环是在阻塞poll阶段等待回调被加入poll队列</p></li> <li><p>setImmediate()具有最高优先级，只要poll队列为空，代码被setImmediate()，无论是否有timers达到下限时间，setImmediate()的代码都先执行。</p></li></ul> <h4 id="check阶段"><a href="#check阶段" class="header-anchor">#</a> check阶段</h4> <p>这个阶段允许在poll阶段结束后立即执行回调。如果poll阶段空闲，并且有被setImmediate()设定的回调，那么事件循环直接跳到check执行而不是阻塞在poll阶段等待回调被加入。
setImmediate() 实际上是一种特殊的计时器，有自己特有的阶段。</p> <h4 id="close-callbacks"><a href="#close-callbacks" class="header-anchor">#</a> close,callbacks</h4> <p>如果一个socket或handle被突然关掉（比如socket.destroy()），close事件将在这个阶段被触发，否则将通过process.nextTick()触发。</p> <h4 id="setimmediate-vs-settimeout"><a href="#setimmediate-vs-settimeout" class="header-anchor">#</a> setImmediate() vs setTimeout()</h4> <p>setImmediate 和 setTimeout 很相似，但是其回调函数的调用时机却不一样。
setImmediate() 的作用是在当前 poll 阶段结束后调用一个函数。
setTimeout() 的作用是在一段时间后调用一个函数。
这两者的回调的执行顺序取决于 setTimeout 和 setImmediate 被调用时的环境。
如果 setTimeout 和 setImmediate 都是在主模块（main module）中被调用的，那么回调的执行顺序取决于当前进程的性能，这个性能受其他应用程序进程的影响。</p> <ul><li>举例来说，如果在主模块中运行下面的脚本，那么两个回调的执行顺序是无法判断的：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// timeout_vs_immediate.js</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>如果把上面代码放到 I/O 操作的回调里，setImmediate 的回调就总是优先于 setTimeout 的回调</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// timeout_vs_immediate.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>setImmediate 的主要优势就是，如果在 I/O 操作的回调里，setImmediate 的回调总是比 setTimeout 的回调先执行。</li></ul> <h4 id="process-nexttick-and-promise"><a href="#process-nexttick-and-promise" class="header-anchor">#</a> process.nextTick() and Promise</h4> <ul><li><p>他们都会在其所处的事件循环最后，事件循环进入下一个循环的阶段前执行。</p></li> <li><p>你可能发现 process.nextTick() 这个重要的异步 API 没有出现在任何一个阶段里，那是因为从技术上来讲 process.nextTick() 并不是 event loop 的一部分。实际上，不管 event loop 当前处于哪个阶段，nextTick 队列都是在当前阶段后就被执行了。</p></li> <li><p>任何一个阶段调用 process.nextTick(回调)，回调都会在当前阶段继续运行前被调用。这种行为有的时候会造成不好的结果，因为你可以递归地调用 process.nextTick()，这样 event loop 就会一直停在当前阶段不走……无法进入 poll 阶段。</p></li> <li><p>因为有些异步 API 需要保证一致性，即使可以同步完成，也要保证异步操作的顺序</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> bar<span class="token punctuation">;</span>

<span class="token comment">// 这是一个异步 API，但是却同步地调用了 callback</span>
<span class="token keyword">function</span> <span class="token function">someAsyncApiCall</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">//`someAsyncApiCall` 在执行过程中就调用了回调</span>
<span class="token function">someAsyncApiCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 此时 bar 还没有被赋值为 1</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

bar <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>一个使用例子</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>.listen(8080) 这句话是同步执行的。问题在于 listening 回调无法被触发，因为 listening 的监听代码在 .listen(8080) 的后面。
为了解决这个问题，.listen() 函数可以使用 process.nextTick() 来执行 listening 事件的回调。</p> <h4 id="process-nexttick-vs-setimmediate"><a href="#process-nexttick-vs-setimmediate" class="header-anchor">#</a> process.nextTick() vs setImmediate()</h4> <p>process.nextTick() 的回调会在当前 event loop 阶段「立即」执行。 setImmediate() 的回调会在后续的 event loop 周期（tick）执行。</p> <h4 id="什么时候使用process-nexttick"><a href="#什么时候使用process-nexttick" class="header-anchor">#</a> 什么时候使用process.nextTick</h4> <ul><li>一个类继承了 EventEmitter，而且想在实例化的时候触发一个事件</li> <li>不能直接在构造函数里执行 this.emit('event')，因为这样的话后面的回调就永远无法执行。把 this.emit('event') 放在 process.nextTick() 里，后面的回调就可以执行，这才是我们预期的行为</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">MyEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">EventEmitter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//this.emit('event')</span>
  <span class="token comment">//这个回调不会被执行，需要使用process.nextTick()</span>
  <span class="token comment">// use nextTick to emit the event once a handler is assigned</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
util<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>MyEmitter<span class="token punctuation">,</span> EventEmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'an event occurred!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>2.Javascript的事件循环</p> <ul><li>首先来给一张图</li></ul> <p><img src="https://i.loli.net/2020/05/15/k9L5WmXBVJPo7Mp.png" alt="16dd55ca2fd82de5.png"></p> <h4 id="任务队列-task-queue-和-microtask-queue"><a href="#任务队列-task-queue-和-microtask-queue" class="header-anchor">#</a> 任务队列(Task Queue 和 Microtask Queue )</h4> <ol><li><p>Task queue 大任务
常见的有 setTimetout，setInterval，setImmediate ，I/O，用户交互，UI渲染</p></li> <li><p>Microtask queue
常见的有 promise，Process.nextTick()</p></li> <li><p>事件循环的执行流程</p> <p>3.1 检查 Microtask 队列是否为空,若不为空，则进行下一步，若为空，则跳到3.3</p> <p>3.2 从 microtask 队列中取队首(在队列时间最长)的任务进去执行栈中执行(仅仅一个)，执行完后进入下一步</p> <p>3.3 检查 Microtask 队列是否为空，若不为空，则进入下一步，否则，跳到3.1（开始新的事件循环）</p> <p>3.4 从 Microtask 队列中取队首(在队列时间最长)的任务进去事件队列执行,执行完后，跳到3.3 其中，在执行代码过程中新增的microtask任务会在当前事件循环周期内执行，而新增的macrotask任务只能等到下一个事件循环才能执行了。</p></li></ol> <h4 id="异步理解"><a href="#异步理解" class="header-anchor">#</a> 异步理解</h4></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="container" data-v-0178ff65><canvas id="live2d" width="280" height="250" class="live2d-right" data-v-0178ff65></canvas></div></div></div>
    <script src="/assets/js/app.bd0d2868.js" defer></script><script src="/assets/js/3.1ca9eadf.js" defer></script><script src="/assets/js/1.ad416145.js" defer></script><script src="/assets/js/74.53a7fd75.js" defer></script>
  </body>
</html>
